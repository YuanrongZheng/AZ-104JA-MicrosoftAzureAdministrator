---
lab:
    title: '02b - Azure ポリシーを介してガバナンスを管理する'
    module: 'モジュール 02 - ガバナンスとコンプライアンス'
---

# ラボ 02b - Azure Policy を使用してガバナンスを管理する
# 受講者用ラボ マニュアル

## ラボ シナリオ

Contoso の Azure リソースの管理を強化するために、次の機能を実装する必要があります。

- Cloud Shell ストレージ アカウントなどインフラストラクチャ リソースのみを含むリソース グループにタグを付ける

- 適切にタグ付けされたインフラストラクチャ リソースのみをインフラストラクチャ リソース グループに追加できることを確認する

- 非準拠リソースを修正する 

## 目標

このラボでは、次の操作を行います。

+ タスク 1: Azure portal を介してタグを作成し、割り当てる
+ タスク 2: Azure ポリシーを使用してタグ付けを強制する
+ タスク 3: Azure ポリシーを使用してタグ付けを適用する

## 予想時間: 30分間

## 指示

### エクササイズ 1

#### タスク 1: Azure portal を使用してタグを割り当てる

このタスクでは、Azure portal を介してタグを作成し、Azure リソース グループに割り当てます。

1. Azure portal で **Cloud Shell** 内の **PowerShell** セッションを開始します。

    >**注**: **Cloud Shell** を初めて起動し、「 **ストレージがマウントされていません**」というメッセージが表示されたら、このラボで使用しているサブスクリプションを選択し、「**ストレージの作成**」 をクリックします。 

1. 「Cloud Shell」 ウィンドウで次の手順を実行し、Cloud Shell で使用されるストレージ アカウントの名前を確認します。

   ```pwsh
   df
   ```

1. コマンドの出力で、Cloud Shell ホーム ドライブ マウントを指定する完全修飾パスの最初の部分に注意してください (ここでは`xxxxxxxxxxxxxx`とマークされています)。

   ```
   //xxxxxxxxxxxxxx.file.core.windows.net/cloudshell   (..)  /usr/csuser/clouddrive
   ```

1. Azure portal で、「**ストレージ アカウント**」を検索して選択し、ストレージ アカウントの一覧で、前の手順で特定したストレージ アカウントを表すエントリをクリックします。

1. 「ストレージ アカウント」 ブレードで、ストレージ アカウントを含む**リソース グループの名前のリンク**をクリックします。

1. 「リソース グループ」 ブレードで 「**タグ**」 をクリックします。

1. 次の設定でタグを作成し、変更を保存します。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **Role** |
    | 値 | **Infra** |

1. ストレージ アカウント ブレードに戻ります。「**概要**」 をレビューし、新しいタグがストレージ アカウントに自動的に割り当てられていることを確認します。 

#### タスク 2: Azure ポリシーを使用してタグ付けを強制する

このタスクでは、「*タグとその値がリソースに必要*」という組み込みポリシーをリソース グループに割り当て、結果を評価します。 

1. Azure portal で、「**ポリシー**」 を検索して選択します。 

1. 「**作成**」 セクションで 「**定義**」 をクリックします。使用できる組み込みポリシー定義のリストを確認してください。タグの使用に関連するすべての組み込みポリシーを一覧表示するには、「**カテゴリ**」 ドロップダウン リストで 「**Tags**」 エントリを選択します (他のエントリはすべて選択解除します)。 

1. 「**タグとその値がリソースに必要**」という組み込みポリシーのエントリーをクリックし、その定義をレビューします。

1. 「**タグとその値がリソースに必要**」 という組み込みポリシーの定義ブレードで、「**割り当て**」 をクリックします。

1. スコープの *...* ボタンをクリックして次の値を選択し、**スコープ**を指定します。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | 前のタスクで識別した Cloud Shell アカウントを含むリソース グループの名前 |

    >**注**: スコープによって、ポリシーの割り当てが有効なリソースまたはリソース グループが決まります。管理グループ、サブスクリプション、またはリソース グループ のレベルでポリシーを割り当てることができます。また、個々のサブスクリプション、リソース グループ、リソースなどの除外を指定することもできます (割り当てスコープに基づきます)。 

1. 次の設定を指定して、割り当ての **基本**プロパティを構成します (その他は既定値のままにします)。 

    | 設定 | 値 |
    | --- | --- |
    | 割り当て名 | **Infra という値を持つ Role タグが必要**|
    | 説明 | **Cloud Shell リソース グループ内のすべてのリソースの Infra という値を含む Role タグを必要とします**|
    | ポリシーの適用 | 有効にする |

    >**注**: 「**割り当て名**」 には、選択したポリシー名が自動的に入力されますが、変更することもできます。「**説明**」 オプションで追加することもできます。「**割り当て者**」 は、割り当てを作成するユーザー名に基づいて自動的に設定されます。 

1. 「**次へ**」 をクリックして、「**パラメーター**」 に次の値を設定します。

    | 設定 | 値 |
    | --- | --- |
    | タグ名 | **Role** |
    | タグ値 | **Infra** |

1. 「**次へ**」 をクリックして、「**修復**」 タブをレビューします。「**マネージド IDを作成する**」 のチェックを外したままにしておきます。 

    >**注**: この設定は、ポリシーまたはイニシアチブに **deployIfNotExists** または **Modify** の効果が含まれている場合に使用できます。

1. 「**確認および作成**」 をクリックしてから、「**作成**」 をクリックします。

    >**注**: ここで、必要なタグを明示的に追加せずに、リソース グループに別の Azure Storage ストレージ アカウントを作成することによって、新しいポリシーが有効に割り当てられていることを確認します。 
    
    >**注**: ポリシーが有効になるまでに 5 分から 15 分かかる場合があります。

1. Cloud Shell ホーム ドライブに使用されているストレージ アカウントをホストしている、リソース グループのブレードに戻ります。これは前のタスクで特定したものです。

1. 「リソース グループ」 ブレードで、「**+ 追加**」 をクリックします。

1. 「**新規**」 ブレードで、「**ストレージ アカウント - BLOB、ファイル、テーブル、キュー**」 を検索して選択し、「**作成**」 をクリック します。 

1. 「**ストレージ アカウントの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定して 「**確認 + 作成**」 をクリックします。その他の設定は既定値のままにします。

    | 設定 | 値 |
    | --- | --- |
    | ストレージ アカウント名 | 英字で始まる、グローバルに一意な、3 個から 24 個の小文字と数字の任意の組み合わせ |

1. 検証が失敗したことを確認します。「**検証に 失敗しました**」 リンクをクリックします。「**ここをクリックして詳細を見る**」 をクリックして 「**エラー**」 ブレードを表示し、エラーの原因を特定します。 

    >**注**: エラー メッセージは、ポリシーによってリソースのデプロイが許可されなかったことを示しています。 

    >**注**: 「**未処理エラー**」 タブをクリックすると、「**Infra 値を持つロール タグを必要とする**」 というロール定義名を含む、エラーの詳細を確認できます。デプロイに失敗したのは、作成しようとしたストレージ アカウントに、**Infra** 値に設定された **Role** という名前のタグがなかったためです。

#### タスク 3: Azure ポリシーを使用してタグ付けを適用する

このタスクでは、別のポリシー定義を使用して、非準拠のリソースを修復します。 

1. Azure portal で、「**ポリシー**」 を検索して選択します。 

1. 「**作成**」 セクションで、「**割り当て**」 をクリックします。 

1. 割り当ての一覧で、**Infra 値を持つロール タグを必要とする** ポリシーの割り当てを表す行の省略記号のアイコンを右クリックし、「**割り当ての削除**」 メニューの項目を使用してこの割り当てを削除します。 

1. 「**ポリシーの割り当て**」 をクリックし、スコープの**...**ボタンをクリックして次の値を選択し、「**スコープ**」を指定します。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | 最初のタスクで特定した Cloud Shell アカウントを含むリソース グループの名前 |

1. 「**ポリシー定義**」 を指定するには、**...**ボタンをクリックし、「**存在しない場合は、リソース グループからタグを継承する**」 を検索して選択します。

1. 次の設定を指定して、その割り当ての残りの 「**基本**」 プロパティを構成します。その他の設定は既定値のままにします。

    | 設定 | 値 |
    | --- | --- |
    | 割り当て名 | **Role タグの値がなければ、Cloud Shell リソース グループから継承する**|
    | 説明 | **Role タグの値がなければ、Cloud Shell リソース グループから継承する**|
    | ポリシーの適用 | Enabled |

1. 「**次へ**」 をクリックして、「**パラメーター**」 に次の値を設定します。

    | 設定 | 値 |
    | --- | --- |
    | タグ名 | **Role** |

1. 「**次へ**」 をクリックし、「**修復**」 タブで次の設定を構成します。その他の設定は既定値のままにします。

    | 設定 | 値 |
    | --- | --- |
    | 修復タスクの作成 | enabled |
    | 修復するポリシー | **設定がない場合、リソース グループからタグを継承する** |

    >**注**: このポリシー定義には 「**変更**」 の効果が含まれます。

1. 「**確認および作成**」 をクリックしてから、「**作成**」 をクリックします。

    >**注**: 新しいポリシーの割り当てが有効であることを確認するには、必要なタグを明示的に追加せずに、同じリソース グループに別の Azure ストレージ アカウントを作成します。 
    
    >**注**: ポリシーが有効になるまでに 5 分から 15 分かかる場合があります。

1. Cloud Shell ホーム ドライブに使用されるストレージ アカウントをホストしているリソース グループのブレードに戻ります。これは前のタスクで特定したものです。

1. 「リソース グループ」 ブレードで、「**+ Add**」 をクリックします。

1. 「**新規**」 ブレードで、「**ストレージ アカウント - BLOB、ファイル、テーブル、キュー**」 を検索して選択し、「**作成**」 をクリック します。 

1. 「**ストレージ アカウントの作成**」 ブレードの 「**基本**」 タブで、次の設定を指定して 「**確認 + 作成**」 をクリックします。その他の設定は既定値のままにします。

    | 設定 | 値 |
    | --- | --- |
    | ストレージ アカウント名 | 英字で始まる、グローバルに一意な、3 個から 24 個の小文字と数字の任意の組み合わせ |

1. 今度は検証に成功したことを確認し、「**作成**」 をクリックします。

1. 新しいストレージ アカウントがプロビジョニングされたら、「**リソースに移動**」 ボタンをクリックし、新しく作成したストレージ アカウントの 「**概要**」 ブレードで、**Infra** 値を持つ **Role** タグが自動的にリソースに割り当てられていること確認します。

#### リソースのクリーンアップ

   >**注**: 新しく使用した Azure リソースのうち、使用しないリソースは必ず削除してください。 

   >**注**: 未使用のリソースを削除することで、予期しない費用の発生を防げます。なお、Azure ポリシーに追加の費用はかかりません。

1. ポータルで、「**ポリシー**」 を検索して選択します。

1. 「**作成**」 セクションで 「**割り当て**」 をクリックし、前のタスクで作成した割り当ての右側にある省略記号アイコンをクリックし、「**割り当ての削除**」 をクリックします。 

1. ポータルで、「**ストレージ アカウント**」 を検索して選択 します。

1. ストレージ アカウントの一覧で、このラボの最後のタスクで作成したストレージ アカウントを選択し、「**削除**」 をクリックします。確認を求められたら、「**削除の確認**」 で「**yes**」を入力し、「**削除**」 をクリックします。 

#### レビュー

このラボでは、次の内容を学習しました。

- Azure portal での月の作成と割り当て
- Azure Policy でのタグ付けの強制
- Azure Policy でのタグ付けの適用
